<!-- public/watch.html -->
<!doctype html>
<meta charset="utf-8">
<title>Tonton</title>
<link rel="stylesheet" href="/public/styles.css">
<h1>Tonton</h1>

<nav>
  <a href="/public/browse.html">Browse</a>
  <a href="/public/dashboard.html">Dashboard</a>
  <span class="spacer"></span>
  <span id="userbar" class="badge">Memuat user…</span>
</nav>
<script>
// loadMe() sama
(async function loadMe(){ try{const r=await fetch('/api/me');const j=await r.json();const el=document.getElementById('userbar');if(j.ok&&j.user){el.innerHTML=`Login: <b>${j.user.username}</b> &lt;${j.user.email}&gt;`;}else{el.innerHTML=`<a href="/public/auth/login.html">Login</a>`;}}catch{document.getElementById('userbar').textContent='User: (gagal memuat)';}})();
</script>

<video id="player" controls style="max-width:100%;width:960px;"></video>
<div id="wm" style="position:fixed;right:12px;bottom:12px;opacity:.7;font:14px/1.2 system-ui;background:rgba(0,0,0,.4);color:#fff;padding:6px 10px;border-radius:10px;pointer-events:none"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
(async () => {
  const p = new URLSearchParams(location.search);
  const vid = p.get('video_id');
  if (!vid) { document.body.insertAdjacentHTML('beforeend','<p>video_id kosong</p>'); return; }

  // tampilkan link balik ke video aktif
  const back = document.createElement('a');
  back.href = '/public/watch.html?video_id=' + encodeURIComponent(vid);
  back.textContent = 'Halaman ini';
  document.querySelector('nav').insertAdjacentElement('afterbegin', back);

  const r = await fetch(`/api/request_play?video_id=${encodeURIComponent(vid)}`);
  const j = await r.json();
  if (!r.ok) { alert(j.error || 'gagal request_play'); return; }

  // tampilkan watermark client-side (quick fix, non-secure)
  try {
    const me = await (await fetch('/api/me')).json();
    if (me.ok && me.user) {
      const now = new Date().toLocaleString('id-ID');
      document.getElementById('wm').textContent = `${me.user.username} • ${now}`;
    }
  } catch {}

  const src = j.playlist;
  const video = document.getElementById('player');
  if (Hls.isSupported()) { const hls = new Hls(); hls.loadSource(src); hls.attachMedia(video); }
  else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = src; }
  else { document.body.insertAdjacentHTML('beforeend','<p>Browser tidak mendukung HLS.</p>'); }
})();
</script>
