<!-- public/dashboard.html -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; margin: 16px; }
    nav { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .spacer { flex: 1 1 auto; }
    .badge { background: rgba(0,0,0,.08); padding: 4px 8px; border-radius: 8px; }
    .card { border:1px solid rgba(0,0,0,.15); border-radius:12px; padding:16px; margin:18px 0; background:rgba(0,0,0,.03); }
    label { display:block; margin:10px 0; }
    input, select, button, textarea { font: inherit; padding:8px 10px; }
    textarea { width: 100%; resize: vertical; }
    button.primary { background:#0b67ff; color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; }
    button.ghost { background:transparent; border:1px dashed rgba(0,0,0,.35); border-radius:10px; padding:8px 10px; cursor:pointer; }
    small.muted { opacity:.8; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .list-empty { opacity:.75; padding:8px 0; }
    code.kbd { background: rgba(0,0,0,.08); padding: 0 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <nav>
    <a href="/public/browse.html">Browse</a>
    <a href="/public/dashboard.html" aria-current="page">Dashboard</a>
    <span class="spacer"></span>
    <span id="userbar" class="badge">Memuat user…</span>
    <form id="logoutForm" onsubmit="return false">
      <button id="logoutBtn" class="primary" type="button" title="Logout aman (POST)">Logout</button>
    </form>
  </nav>

  <h1>Dashboard Pengguna</h1>

  <section class="card">
    <p>Selamat datang di platform streaming video berbayar! Upload video Anda, tetapkan harga, dan dapatkan penghasilan dari penonton.</p>
    <p class="muted">Tip: tekan <code class="kbd">F</code> di halaman Tonton untuk toggle fullscreen.</p>
  </section>

  <!-- ================= Edit Profile ================= -->
  <section class="card">
    <h2>Edit Profile & Kontak</h2>
    <form id="profileForm">
      <label>Email
        <input name="email" type="email" readonly disabled>
      </label>
      <label>Nomor WhatsApp
        <input name="whatsapp" placeholder="contoh: 62812xxxxxxx">
      </label>
      <label>Rekening Bank
        <input name="bank_account" placeholder="BCA 1234567890 a/n Nama">
      </label>
      <label>Rekening Wallet (OVO/DANA/GoPay/USDT)
        <input name="wallet_account" placeholder="DANA 08xxxxxxxxxx">
      </label>
      <label>Deskripsi Profil
        <textarea name="profile_desc" rows="3" placeholder="Tuliskan deskripsi singkat tentang Anda atau cara konfirmasi transfer."></textarea>
      </label>
      <button class="primary">Simpan Profile</button>
    </form>
    <small class="muted">Informasi ini akan muncul di halaman video Anda agar penonton bisa melakukan transfer & konfirmasi langsung.</small>
  </section>

  <!-- ================= Video Saya & Akses ================= -->
  <section class="card">
    <div class="row">
      <h2 style="margin:0">Video Saya & Akses</h2>
      <button id="refreshBtn" class="ghost" type="button" title="Refresh daftar">↻ Refresh</button>
    </div>
    <div id="mine" class="list-empty">Memuat…</div>
  </section>

  <!-- ================= Upload ================= -->
  <section class="card">
    <h2>Upload Video</h2>
    <form id="uploadForm" enctype="multipart/form-data">
      <label>Judul
        <input name="title" value="Untitled" required maxlength="160">
      </label>
      <label>Deskripsi (opsional)
        <textarea name="description" rows="3" placeholder="Tuliskan ringkasan video…"></textarea>
      </label>
      <label>Harga (cents)
        <input name="price_cents" type="number" min="0" value="0" required>
      </label>
      <label>File MP4
        <input name="file" type="file" accept="video/mp4" required>
      </label>
      <button class="primary" type="submit">Upload</button>
    </form>
    <small class="muted">Catatan: pastikan file berformat MP4.</small>
  </section>

  <!-- ================= Allowlist ================= -->
  <section class="card">
    <h2>Grant Akses (Allowlist)</h2>
    <form id="allow">
      <label>Video
        <select id="videoSelect" required></select>
      </label>
      <input type="hidden" name="video_id" id="videoIdHidden">
      <small id="videoIdEcho" class="muted" style="display:block;margin:-6px 0 8px 0"></small>

      <label>Username yg diizinkan
        <input name="username" id="usernameInp" required>
      </label>
      <div id="lookup" class="muted" style="font-size:12px;min-height:1.2em"></div>

      <button class="primary">Tambah</button>
    </form>
  </section>

  <script>
  // ===== util =====
  function toast(msg, ok=true){ alert((ok ? "✅ " : "❌ ") + msg); }
  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ===== user bar =====
  (async function loadMe(){
    try {
      const r = await fetch('/api/me');
      const j = await r.json();
      const el = document.getElementById('userbar');
      if(j.ok && j.user){
        el.innerHTML = `Login: <b>${escapeHtml(j.user.username)}</b> &lt;${escapeHtml(j.user.email)}&gt;`;
      } else {
        el.innerHTML = `<a href="/public/auth/login.html">Login</a>`;
      }
    } catch {
      document.getElementById('userbar').textContent='User: (gagal memuat)';
    }
  })();

  // ===== Logout =====
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      await fetch('/auth/logout', { method: 'POST' });
      location.href = '/public/auth/login.html?status=ok';
    } catch {
      location.href = '/public/auth/login.html';
    }
  });

  // ================= Edit Profile =================
  (async function initProfile(){
    try {
      const r = await fetch('/api/profile');
      const j = await r.json();
      if(j.ok && j.profile){
        const f = document.getElementById('profileForm');
        f.email.value = j.profile.email || '';
        f.whatsapp.value = j.profile.whatsapp || '';
        f.bank_account.value = j.profile.bank_account || '';
        f.wallet_account.value = j.profile.wallet_account || '';
        f.profile_desc.value = j.profile.profile_desc || '';
      }
    } catch {}
    document.getElementById('profileForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      fd.delete('email'); // jangan kirim email
      const body = new URLSearchParams(fd);
      try {
        const r = await fetch('/api/profile_update', {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        const j = await r.json().catch(async()=>({ok:false,error:await r.text()}));
        toast(j.ok ? 'Profile tersimpan' : 'Gagal: '+(j.error||'unknown'), j.ok);
      } catch(err){ toast('Gagal: '+err, false); }
    });
  })();

  // ================= Upload =================
  const uploadForm = document.getElementById('uploadForm');
  uploadForm.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadForm);
    try {
      const r = await fetch('/api/upload', { method: 'POST', body: formData });
      const j = (r.headers.get('content-type')||'').includes('application/json') ? await r.json() : { error: await r.text() };
      if (!r.ok || j.ok === false) return toast(`Upload gagal: ${j.error || 'unknown error'}`, false);
      toast(`Upload sukses. Video ID: ${j.video_id}`);
      uploadForm.reset();
      await loadMyVideos(); await renderMyVideos();
    } catch (e2) { toast(`Upload gagal: ${e2}`, false); }
  };

  // ================= Allowlist =================
  const allowForm    = document.getElementById('allow');
  const videoSelect  = document.getElementById('videoSelect');
  const videoHidden  = document.getElementById('videoIdHidden');
  const videoEcho    = document.getElementById('videoIdEcho');
  const usernameInp  = document.getElementById('usernameInp');
  const lookupBox    = document.getElementById('lookup');

  function syncVideoIdEcho(){
    const vid = videoSelect.value || "";
    videoHidden.value = vid;
    videoEcho.textContent = vid ? `video_id: ${vid} ` : '';
    if (vid) {
      videoEcho.innerHTML = `video_id: ${escapeHtml(vid)} <button class="ghost" type="button" id="copyVidBtn">Copy</button>`;
      const btn = document.getElementById('copyVidBtn');
      btn.onclick = async () => {
        try { await navigator.clipboard.writeText(vid); toast('Video ID disalin'); } catch {}
      };
    }
  }

  async function loadMyVideos(){
    try {
      const r = await fetch('/api/my_videos');
      const j = await r.json();
      if (j.ok && Array.isArray(j.videos) && j.videos.length) {
        videoSelect.innerHTML = j.videos.map(v => `<option value="${v.id}">${escapeHtml(v.title)} — ${v.id}</option>`).join('');
      } else {
        videoSelect.innerHTML = '<option value="">(Belum ada video)</option>';
      }
    } catch {
      videoSelect.innerHTML = '<option value="">Gagal load video</option>';
    }
    syncVideoIdEcho(); // set hidden setiap kali selesai memuat daftar
  }

  // Pastikan hidden ikut berubah saat user ganti pilihan
  videoSelect.addEventListener('change', syncVideoIdEcho);

  // Lookup user_id live (debounce)
  let t;
  usernameInp.addEventListener('input', () => {
    clearTimeout(t);
    const u = usernameInp.value.trim();
    lookupBox.textContent = '';
    if (!u) return;
    t = setTimeout(async () => {
      try {
        const r = await fetch('/api/user_lookup?' + new URLSearchParams({ username: u }));
        const j = await r.json();
        lookupBox.textContent = (j.ok && j.user)
          ? `→ user_id: ${j.user.id}`
          : '→ user tidak ditemukan';
      } catch {
        lookupBox.textContent = '→ gagal lookup user';
      }
    }, 300);
  });

  allowForm.onsubmit = async (e) => {
    e.preventDefault();
    const uname = usernameInp.value.trim();
    const vid = videoHidden.value.trim();

    if (!vid) return toast('Pilih video terlebih dahulu (video_id kosong).', false);
    if (!uname) return toast('Isi username dulu.', false);

    // re-cek cepat (opsional)
    try {
      const r0 = await fetch('/api/user_lookup?' + new URLSearchParams({ username: uname }));
      const j0 = await r0.json();
      if (!(j0.ok && j0.user && j0.user.id)) {
        lookupBox.textContent = '→ user tidak ditemukan';
        return toast('Gagal: user tidak ditemukan', false);
      }
    } catch {}

    const body = new URLSearchParams(new FormData(allowForm));
    try {
      const r = await fetch('/api/allow', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const j = await r.json().catch(async()=>({ok:false,error:await r.text()}));
      if (!r.ok || j.ok === false) return toast(`Gagal allowlist: ${j.error||'unknown'}`, false);

      // Info tambahan kalau duplikat (rows_affected=0)
      if (typeof j.rows_affected === 'number' && j.rows_affected === 0) {
        toast(`Allowlist: ${j.username} sudah ada untuk video ${j.video_id} (duplikat).`);
      } else {
        toast(`Allowlist sukses: ${j.username} → video ${j.video_id}`);
      }

      allowForm.reset();
      lookupBox.textContent = '';
      syncVideoIdEcho(); // reset hidden setelah form direset
      await renderMyVideos();
    } catch (e2) { toast(`Gagal allowlist: ${e2}`, false); }
  };

  // ================= Render "Video Saya" =================
  async function renderMyVideos() {
    const box = document.getElementById('mine');
    box.innerHTML = '<p>Memuat…</p>';
    try {
      const r = await fetch('/api/my_videos');
      const j = await r.json();
      if (!j.ok) return box.innerHTML = `<p class="muted">Gagal memuat: ${j.error || 'unknown'}</p>`;
      if (!Array.isArray(j.videos) || j.videos.length === 0)
        return box.innerHTML = '<p class="list-empty">Belum ada video yang Anda unggah.</p>';

      const html = j.videos.map(v => {
        const users = (v.allow_users || []).map(u => `<code>${escapeHtml(u)}</code>`).join(', ');
        const priceIDR = (v.price_cents/100).toLocaleString('id-ID');
        return `
          <div class="card" style="background:rgba(0,0,0,.02)">
            <h3 style="margin:0 0 6px 0">${escapeHtml(v.title)}</h3>
            <small class="muted">ID: ${escapeHtml(v.id)} • Dibuat: ${escapeHtml(v.created_at)}</small>
            <p style="margin:8px 0 4px 0">Harga sekarang: Rp ${priceIDR}</p>
            <details>
              <summary>Edit judul, deskripsi, dan harga (cent)</summary>
              <form class="edit-form" data-video-id="${escapeHtml(v.id)}" style="margin-top:10px">
                <!-- penting: name="id" agar cocok dengan UpdateVideoForm -->
                <input type="hidden" name="id" value="${escapeHtml(v.id)}">
                <label>Judul
                  <input name="title" required maxlength="160" value="${escapeHtml(v.title)}">
                </label>
                <label>Deskripsi
                  <textarea name="description" rows="3">${escapeHtml(v.description || '')}</textarea>
                </label>
                <label>Harga (cents)
                  <input name="price_cents" type="number" min="0" required value="${v.price_cents}">
                </label>
                <button class="primary" type="submit">Simpan Perubahan</button>
              </form>
            </details>
            <details style="margin-top:8px">
              <summary>Allowlist (${v.allow_count})</summary>
              <div style="margin-top:6px">${users || '<span class="muted">(Belum ada user diizinkan)</span>'}</div>
            </details>
          </div>`;
      }).join('');
      box.innerHTML = html;
    } catch (e) { box.innerHTML = `<p class="muted">Error: ${e}</p>`; }
  }

  document.getElementById('mine').addEventListener('submit', async (e) => {
    const form = e.target.closest('form.edit-form');
    if (!form) return;
    e.preventDefault();
    const body = new URLSearchParams(new FormData(form));
    const pc = Number(body.get('price_cents') || 0);
    if (Number.isNaN(pc) || pc < 0) return toast('Harga (cents) harus >= 0', false);
    try {
      const r = await fetch('/api/video_update', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const txt = await r.text(); // konsumsi sekali
      let j; try { j = JSON.parse(txt); } catch { j = { ok:false, error: txt || 'non-JSON response' }; }
      if (!r.ok || j.ok === false) toast('Gagal update: ' + (j.error || 'unknown'), false);
      else { toast('Video berhasil diupdate'); await renderMyVideos(); await loadMyVideos(); }
    } catch (err) { toast('Gagal update: ' + err, false); }
  });

  // ===== Init =====
  (async () => { await loadMyVideos(); await renderMyVideos(); })();
  document.getElementById('refreshBtn').addEventListener('click', async () => { await loadMyVideos(); await renderMyVideos(); });
  </script>
</body>
</html>
